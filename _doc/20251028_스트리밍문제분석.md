# 스트리밍 전용 모드 화면 멈춤 문제 분석

## 문제 증상
- 프로그램 시작 후 카메라를 스트리밍만 되도록 연결하면 화면이 멈춤
- 녹화를 시작하면 그때부터 실시간으로 표시됨

## 수행한 조치

### 1. Valve 초기값 설정
**위치**: `streaming/gst_pipeline.py`

#### 변경 내용:
```python
# 스트리밍 valve 초기값 명시적 설정 (240-243줄)
self.streaming_valve.set_property("drop", False)  # 기본적으로 열림
logger.debug("[VALVE DEBUG] streaming_valve initial state: drop=False (open)")

# 녹화 valve 디버그 로그 추가 (448줄)
logger.debug("[VALVE DEBUG] recording_valve initial state: drop=True (closed)")
```

### 2. Valve 상태 모니터링 개선
**위치**: `_apply_mode_settings()` 메소드

#### 변경 내용:
- 모드 변경 전후 valve 상태 확인 로그 추가
- 상태 불일치 시 경고 메시지 출력

### 3. PLAYING 상태 전환 후 Valve 재설정
**위치**: `start()` 메소드 (741-742줄)

#### 변경 내용:
```python
# PLAYING 상태 전환 후 valve 상태 재적용
logger.debug("[VALVE DEBUG] Re-applying valve settings after successful PLAYING state transition")
self._apply_mode_settings()
```

### 4. Tee 설정 수정
**위치**: `create_pipeline()` 메소드 (173-176줄)

#### 변경 내용:
```python
# pull-mode 설정 제거 (문제 가능성)
self.tee = Gst.ElementFactory.make("tee", "tee")
self.tee.set_property("allow-not-linked", True)
# self.tee.set_property("pull-mode", 1) <- 제거됨
```

### 5. 스트리밍 큐 버퍼 크기 증가
**위치**: `_create_streaming_branch()` 메소드 (232-235줄)

#### 변경 내용:
```python
stream_queue.set_property("max-size-buffers", 10)  # 5 -> 10으로 증가
stream_queue.set_property("max-size-time", 2 * Gst.SECOND)  # 1초 -> 2초로 증가
```

## 가능한 추가 원인

### 1. 데이터 흐름 문제
- Tee에서 streaming branch로 데이터가 제대로 흐르지 않을 수 있음
- Queue가 너무 빨리 차서 블로킹될 가능성

### 2. 디코더 초기화 문제
- 하드웨어 디코더가 제대로 초기화되지 않았을 가능성
- Windows 환경에서 디코더 호환성 문제

### 3. Window Handle 설정 시점
- Window handle이 너무 늦게 설정될 가능성
- sync message 처리 타이밍 문제

## 디버깅 방법

### 1. 로그 확인
```bash
python main.py --debug
```

다음 로그를 확인:
- `[VALVE DEBUG]` 메시지로 valve 상태 추적
- `[RECORDING DEBUG]` 메시지로 녹화 상태 확인
- Pipeline 상태 변경 메시지

### 2. GStreamer 파이프라인 그래프 생성
```bash
GST_DEBUG_DUMP_DOT_DIR=/tmp python main.py
```
생성된 .dot 파일을 확인하여 파이프라인 구조 검증

### 3. 테스트 시나리오
1. 카메라 연결 (스트리밍만)
2. 로그에서 valve 상태 확인
3. 녹화 시작
4. valve 상태 변경 확인

## 임시 해결 방법
현재는 다음과 같은 방법으로 사용 가능:
1. 카메라 연결 후 즉시 녹화 시작
2. 또는 IT_RNVR.json에서 `recording_enabled_start: true`로 설정

## 향후 개선 사항
1. Valve 대신 다른 방식으로 스트림 제어 고려
2. 파이프라인 구조 단순화
3. 플랫폼별 최적화