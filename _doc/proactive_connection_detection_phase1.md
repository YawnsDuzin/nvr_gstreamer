# Phase 1: RTSP Keep-Aliveë¥¼ í†µí•œ ì—°ê²° ëŠê¹€ ì¡°ê¸° ê°ì§€

**ë‚ ì§œ:** 2025-11-10
**êµ¬í˜„ ë‹¨ê³„:** Phase 1 (RTSP Keep-Alive ì„¤ì •)
**ì˜ˆìƒ ê°ì§€ ì‹œê°„:** 5-10ì´ˆ (ê¸°ì¡´ 30-60ì´ˆ ëŒ€ë¹„ 83-90% ê°œì„ )

---

## ê°œìš”

ì¹´ë©”ë¼ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ëŠê²¼ì„ ë•Œ, í˜„ì¬ëŠ” ì—ëŸ¬ê°€ ë°œìƒí•´ì•¼ ì¬ì—°ê²° ì²˜ë¦¬ê°€ ì‹œì‘ë©ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ì—°ê²° ëŠê¹€ ê°ì§€ê¹Œì§€ 30-60ì´ˆê°€ ì†Œìš”ë©ë‹ˆë‹¤.

**Phase 1**ì—ì„œëŠ” GStreamerì˜ RTSP Keep-Alive ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ì—¬ ì—°ê²° ëŠê¹€ì„ 5-10ì´ˆ ë‚´ì— ê°ì§€í•  ìˆ˜ ìˆë„ë¡ ê°œì„ í•©ë‹ˆë‹¤.

---

## RTSP Keep-Alive ë™ì‘ ì›ë¦¬

### 1. Keep-Alive ë©”ì»¤ë‹ˆì¦˜

```
[í´ë¼ì´ì–¸íŠ¸]                    [RTSP ì„œë²„]
     |                               |
     |--- GET_PARAMETER Request ---->|  (5ì´ˆë§ˆë‹¤)
     |                               |
     |<--- 200 OK Response ----------|  (ì •ìƒ)
     |                               |
     |--- GET_PARAMETER Request ---->|  (5ì´ˆ í›„)
     |                               |
     |    (ì‘ë‹µ ì—†ìŒ - 5ì´ˆ íƒ€ì„ì•„ì›ƒ)    |  (ì—°ê²° ëŠê¹€)
     |                               |
     |[ì—°ê²° ëŠê¹€ ê°ì§€] âœ…              |
     â†“
[ì¬ì—°ê²° ì‹œì‘]
```

### 2. GStreamer rtspsrc ì†ì„±

```python
# do-rtsp-keep-alive: RTSP ì„œë²„ì— ì£¼ê¸°ì ìœ¼ë¡œ keep-alive ë©”ì‹œì§€ ì „ì†¡
rtspsrc.set_property("do-rtsp-keep-alive", True)

# timeout: keep-alive ê°„ê²© ë° ì‘ë‹µ íƒ€ì„ì•„ì›ƒ (microseconds)
# ê°’ì´ ì‘ì„ìˆ˜ë¡ ë¹ ë¥´ê²Œ ê°ì§€í•˜ì§€ë§Œ, ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ ì¦ê°€
rtspsrc.set_property("timeout", 5 * 1000000)  # 5ì´ˆ
```

### 3. ê°ì§€ ì‹œê°„ ê³„ì‚°

```
ìµœëŒ€ ê°ì§€ ì‹œê°„ = keep-alive ê°„ê²© + íƒ€ì„ì•„ì›ƒ
               = 5ì´ˆ + 5ì´ˆ
               = 10ì´ˆ

ìµœì†Œ ê°ì§€ ì‹œê°„ = 0ì´ˆ (ë§ˆì§€ë§‰ keep-alive ì§í›„ ì—°ê²° ëŠê¹€)
í‰ê·  ê°ì§€ ì‹œê°„ = 5ì´ˆ (í†µê³„ì  í‰ê· )
```

---

## êµ¬í˜„ ë‚´ìš©

### 1. íŒŒì´í”„ë¼ì¸ ì„¤ì • ë³€ê²½

**íŒŒì¼:** `camera/gst_pipeline.py`
**ìœ„ì¹˜:** 237-246ë²ˆ ë¼ì¸ (rtspsrc ì†ì„± ì„¤ì • ë¶€ë¶„)

#### ë³€ê²½ ì „

```python
# connection_timeout ì„¤ì • (ê¸°ë³¸ê°’: 10ì´ˆ)
# rtspsrcì˜ timeout ì†ì„±ì€ ì´ˆ ë‹¨ìœ„
connection_timeout = streaming_config.get("connection_timeout", 10)
rtspsrc.set_property("timeout", connection_timeout * 1000000)  # microseconds
logger.debug(f"Connection timeout set to {connection_timeout}s")

rtspsrc.set_property("retry", 5)
```

#### ë³€ê²½ í›„

```python
# RTSP Keep-Alive ì„¤ì • (ì—°ê²° ëŠê¹€ ì¡°ê¸° ê°ì§€)
# do-rtsp-keep-alive: RTSP ì„œë²„ì— ì£¼ê¸°ì ìœ¼ë¡œ keep-alive ë©”ì‹œì§€ ì „ì†¡
rtspsrc.set_property("do-rtsp-keep-alive", True)

# timeout: keep-alive ê°„ê²© ë° ì‘ë‹µ íƒ€ì„ì•„ì›ƒ (microseconds ë‹¨ìœ„)
# ê¸°ë³¸ê°’: 5ì´ˆ (ë¹ ë¥¸ ì—°ê²° ëŠê¹€ ê°ì§€ë¥¼ ìœ„í•´)
# ê°’ì´ ì‘ì„ìˆ˜ë¡ ë¹ ë¥´ê²Œ ê°ì§€í•˜ì§€ë§Œ, ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ ì¦ê°€
keepalive_timeout = streaming_config.get("keepalive_timeout", 5)
rtspsrc.set_property("timeout", keepalive_timeout * 1000000)  # microseconds
logger.debug(f"RTSP keep-alive enabled with {keepalive_timeout}s timeout")

rtspsrc.set_property("retry", 5)
```

#### ì£¼ìš” ë³€ê²½ ì‚¬í•­

1. **do-rtsp-keep-alive í™œì„±í™”**: ì£¼ê¸°ì ì¸ keep-alive ë©”ì‹œì§€ ì „ì†¡
2. **timeout ì˜ë¯¸ ë³€ê²½**:
   - ì´ì „: ë‹¨ìˆœ ì—°ê²° íƒ€ì„ì•„ì›ƒ (10ì´ˆ)
   - ì´í›„: keep-alive ê°„ê²© + íƒ€ì„ì•„ì›ƒ (5ì´ˆ)
3. **ì„¤ì • ì´ë¦„ ë³€ê²½**: `connection_timeout` â†’ `keepalive_timeout` (ë” ëª…í™•í•œ ì˜ë¯¸)
4. **ê¸°ë³¸ê°’ ë‹¨ì¶•**: 10ì´ˆ â†’ 5ì´ˆ (ë¹ ë¥¸ ê°ì§€)

### 2. ì„¤ì • íŒŒì¼ ì—…ë°ì´íŠ¸

**íŒŒì¼:** `IT_RNVR.json`
**ì„¹ì…˜:** `streaming`

#### ì¶”ê°€ëœ ì„¤ì •

```json
{
  "streaming": {
    ...
    "tcp_timeout": 10000,
    "keepalive_timeout": 5,    // â† ìƒˆë¡œ ì¶”ê°€
    "auto_reconnect": true,
    ...
  }
}
```

#### ì„¤ì • ì˜µì…˜

- **keepalive_timeout**: RTSP keep-alive ê°„ê²© (ì´ˆ ë‹¨ìœ„)
  - ê¸°ë³¸ê°’: `5`
  - ê¶Œì¥ ë²”ìœ„: `3-10`
  - ì‘ì€ ê°’: ë¹ ë¥¸ ê°ì§€, ë†’ì€ ë„¤íŠ¸ì›Œí¬ ë¶€í•˜
  - í° ê°’: ëŠë¦° ê°ì§€, ë‚®ì€ ë„¤íŠ¸ì›Œí¬ ë¶€í•˜

---

## ë™ì‘ íë¦„

### ì •ìƒ ì—°ê²° ì‹œ

```
[0ì´ˆ]  Pipeline ì‹œì‘
       â†“
[0ì´ˆ]  RTSP ì—°ê²° ìˆ˜ë¦½
       â†“
[5ì´ˆ]  Keep-alive ì „ì†¡ â†’ 200 OK âœ…
       â†“
[10ì´ˆ] Keep-alive ì „ì†¡ â†’ 200 OK âœ…
       â†“
[15ì´ˆ] Keep-alive ì „ì†¡ â†’ 200 OK âœ…
       ...
```

### ì—°ê²° ëŠê¹€ ê°ì§€

```
[0ì´ˆ]   Keep-alive ì „ì†¡ â†’ 200 OK âœ…
        â†“
[3ì´ˆ]   ì¹´ë©”ë¼ ì „ì› OFF / ë„¤íŠ¸ì›Œí¬ ëŠê¹€ âŒ
        â†“
[5ì´ˆ]   Keep-alive ì „ì†¡ â†’ ì‘ë‹µ ì—†ìŒ â±ï¸
        â†“
[10ì´ˆ]  íƒ€ì„ì•„ì›ƒ â†’ ì—°ê²° ëŠê¹€ ê°ì§€ ğŸš¨
        â†“
        ERROR ë©”ì‹œì§€ ë°œìƒ
        â†“
        _on_bus_message() í˜¸ì¶œ
        â†“
        _handle_error() ì‹¤í–‰
        â†“
        ì¬ì—°ê²° ì‹œì‘ ğŸ”„
```

**ê°ì§€ ì‹œê°„**: 3ì´ˆ(ëŠê¹€) â†’ 10ì´ˆ(ê°ì§€) = **7ì´ˆ ì†Œìš”**

---

## ì´ì „ vs ê°œì„  ë¹„êµ

### ì´ì „ ë°©ì‹ (Error ê¸°ë°˜ ê°ì§€)

```
[ì¹´ë©”ë¼ ì—°ê²° ëŠê¹€]
     â†“
[ë²„í¼ ë°ì´í„° ì†Œì§„] (5-10ì´ˆ)
     â†“
[ë””ì½”ë” ì—ëŸ¬ ë°œìƒ] (10-20ì´ˆ)
     â†“
[íŒŒì´í”„ë¼ì¸ ì—ëŸ¬] (20-30ì´ˆ)
     â†“
[ì¬ì—°ê²° ì‹œì‘] â† ì´ 30-60ì´ˆ ì†Œìš” âŒ
```

### ê°œì„  ë°©ì‹ (Keep-Alive ê¸°ë°˜)

```
[ì¹´ë©”ë¼ ì—°ê²° ëŠê¹€]
     â†“
[Keep-alive íƒ€ì„ì•„ì›ƒ] (ìµœëŒ€ 10ì´ˆ)
     â†“
[ì—°ê²° ëŠê¹€ ê°ì§€]
     â†“
[ì¬ì—°ê²° ì‹œì‘] â† ì´ 5-10ì´ˆ ì†Œìš” âœ…
```

### ê°œì„  íš¨ê³¼

| í•­ëª© | ì´ì „ | ê°œì„  | ê°œì„ ìœ¨ |
|------|------|------|--------|
| ìµœì†Œ ê°ì§€ ì‹œê°„ | 20ì´ˆ | 0ì´ˆ | 100% |
| í‰ê·  ê°ì§€ ì‹œê°„ | 45ì´ˆ | 5ì´ˆ | **89%** |
| ìµœëŒ€ ê°ì§€ ì‹œê°„ | 60ì´ˆ | 10ì´ˆ | **83%** |
| ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ | ë‚®ìŒ | ì¤‘ê°„ | - |

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### í…ŒìŠ¤íŠ¸ 1: ì¹´ë©”ë¼ ì „ì› OFF

**ì ˆì°¨:**
1. í”„ë¡œê·¸ë¨ ì‹¤í–‰ ë° ìŠ¤íŠ¸ë¦¬ë° + ë…¹í™” ì‹œì‘
2. ë¡œê·¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (keep-alive ë©”ì‹œì§€ í™•ì¸)
3. ì¹´ë©”ë¼ ì „ì› OFF
4. ì—°ê²° ëŠê¹€ ê°ì§€ ì‹œê°„ ì¸¡ì •

**ì˜ˆìƒ ê²°ê³¼:**
```
[ì‹œì‘] ìŠ¤íŠ¸ë¦¬ë° ì •ìƒ ë™ì‘
       â†“
[ë¡œê·¸] "RTSP keep-alive enabled with 5s timeout"
       â†“
[ì „ì› OFF] ì¹´ë©”ë¼ ì „ì› ì°¨ë‹¨
       â†“
[5-10ì´ˆ í›„] "[RECONNECT] Starting reconnection..."
       â†“
[ì¬ì—°ê²° ì™„ë£Œ] ìŠ¤íŠ¸ë¦¬ë° + ë…¹í™” ì¬ê°œ
```

### í…ŒìŠ¤íŠ¸ 2: ë„¤íŠ¸ì›Œí¬ ì¼€ì´ë¸” ë¶„ë¦¬

**ì ˆì°¨:**
1. í”„ë¡œê·¸ë¨ ì‹¤í–‰ ë° ìŠ¤íŠ¸ë¦¬ë° + ë…¹í™” ì‹œì‘
2. ë„¤íŠ¸ì›Œí¬ ì¼€ì´ë¸” ë¶„ë¦¬
3. ì—°ê²° ëŠê¹€ ê°ì§€ ì‹œê°„ ì¸¡ì •
4. ë„¤íŠ¸ì›Œí¬ ì¼€ì´ë¸” ì¬ì—°ê²°
5. ìë™ ë³µêµ¬ í™•ì¸

**ì˜ˆìƒ ê²°ê³¼:**
- âœ… 5-10ì´ˆ ë‚´ ì—°ê²° ëŠê¹€ ê°ì§€
- âœ… ì¬ì—°ê²° ì‹œë„ ì‹œì‘
- âœ… ì¼€ì´ë¸” ì¬ì—°ê²° ì‹œ ìë™ ë³µêµ¬
- âœ… ìƒˆë¡œìš´ ë…¹í™” íŒŒì¼ ìƒì„±

### í…ŒìŠ¤íŠ¸ 3: ë„¤íŠ¸ì›Œí¬ ë¶ˆì•ˆì • (ê°„í—ì  ëŠê¹€)

**ì ˆì°¨:**
1. í”„ë¡œê·¸ë¨ ì‹¤í–‰ ë° ìŠ¤íŠ¸ë¦¬ë° + ë…¹í™” ì‹œì‘
2. ë„¤íŠ¸ì›Œí¬ ì¼€ì´ë¸”ì„ ì§§ê²Œ ë¶„ë¦¬ í›„ ì¬ì—°ê²° (2-3ì´ˆ)
3. ì‹œìŠ¤í…œ ë°˜ì‘ í™•ì¸

**ì˜ˆìƒ ê²°ê³¼:**
- âœ… Keep-aliveëŠ” ê³„ì† ì „ì†¡ (ì•„ì§ íƒ€ì„ì•„ì›ƒ ì•ˆë¨)
- âœ… ë²„í¼ë§ìœ¼ë¡œ ì§§ì€ ëŠê¹€ ê·¹ë³µ
- âœ… ë¶ˆí•„ìš”í•œ ì¬ì—°ê²° ë°©ì§€

### í…ŒìŠ¤íŠ¸ 4: Keep-Alive íƒ€ì„ì•„ì›ƒ ì¡°ì •

**ì ˆì°¨:**
1. `IT_RNVR.json`ì—ì„œ `keepalive_timeout` ê°’ ë³€ê²½
   ```json
   "keepalive_timeout": 3  // 3ì´ˆë¡œ ë‹¨ì¶•
   ```
2. í”„ë¡œê·¸ë¨ ì¬ì‹œì‘
3. ì¹´ë©”ë¼ ì „ì› OFF
4. ê°ì§€ ì‹œê°„ ì¸¡ì •

**ì˜ˆìƒ ê²°ê³¼:**
- âœ… 3-6ì´ˆ ë‚´ ì—°ê²° ëŠê¹€ ê°ì§€ (ë” ë¹ ë¦„)
- âš ï¸ ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ ì¦ê°€

---

## ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ ë¶„ì„

### Keep-Alive ë©”ì‹œì§€ í¬ê¸°

```
GET_PARAMETER rtsp://192.168.0.131:554/... RTSP/1.0
CSeq: 123
User-Agent: GStreamer/1.20.3
Session: 12345678

[ë¹ˆ ì¤„]
```

**ì˜ˆìƒ í¬ê¸°**: ì•½ 150-200 ë°”ì´íŠ¸ (ìš”ì²­ + ì‘ë‹µ)

### ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ ê³„ì‚°

```
keepalive_timeout = 5ì´ˆ ê¸°ì¤€

ì´ˆë‹¹ ì „ì†¡ëŸ‰ = 200 bytes / 5ì´ˆ = 40 bytes/s
ë¶„ë‹¹ ì „ì†¡ëŸ‰ = 40 bytes/s Ã— 60s = 2.4 KB/min
ì‹œê°„ë‹¹ ì „ì†¡ëŸ‰ = 2.4 KB/min Ã— 60min = 144 KB/h
ì¼ì¼ ì „ì†¡ëŸ‰ = 144 KB/h Ã— 24h = 3.46 MB/day
```

**ê²°ë¡ **: ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ëŠ” ë¬´ì‹œí•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ (í•˜ë£¨ 3.46MB)

---

## í•œê³„ ë° ë‹¤ìŒ ë‹¨ê³„

### Phase 1ì˜ í•œê³„

1. **RTSP í”„ë¡œí† ì½œ ì˜ì¡´**: RTSP ì„œë²„ê°€ keep-aliveë¥¼ ì§€ì›í•´ì•¼ í•¨
2. **íƒ€ì„ì•„ì›ƒ ê¸°ë°˜**: ì—¬ì „íˆ íƒ€ì„ì•„ì›ƒê¹Œì§€ ëŒ€ê¸° í•„ìš” (ìµœëŒ€ 10ì´ˆ)
3. **ìˆ˜ë™ì  ê°ì§€**: ì„œë²„ ì‘ë‹µì— ì˜ì¡´

### Phase 2: í”„ë ˆì„ ë„ì°© ëª¨ë‹ˆí„°ë§ (ì˜ˆì •)

**ëª©í‘œ**: í”„ë ˆì„ì´ ë„ì°©í•˜ì§€ ì•Šìœ¼ë©´ ì¦‰ì‹œ ê°ì§€ (1-2ì´ˆ)

**ë°©ë²•**: Pad probeë¥¼ ì‚¬ìš©í•œ ëŠ¥ë™ì  í”„ë ˆì„ ëª¨ë‹ˆí„°ë§

```python
def _frame_probe_callback(self, pad, info):
    self._last_frame_time = time.time()
    return Gst.PadProbeReturn.OK

# ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì²´í¬
if time.time() - self._last_frame_time > 2.0:
    logger.warning("No frames received for 2 seconds")
    self._handle_error(Exception("Frame timeout"))
```

### Phase 3: BUFFERING ë©”ì‹œì§€ ê°œì„  (ì˜ˆì •)

**ëª©í‘œ**: ë²„í¼ë§ ìƒíƒœ ëª¨ë‹ˆí„°ë§ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ì¡°ê¸° ê°ì§€

**ë°©ë²•**: BUFFERING ë©”ì‹œì§€ threshold ì„¤ì •

```python
if message.type == Gst.MessageType.BUFFERING:
    percent = message.parse_buffering()
    if percent < 20:  # 20% ë¯¸ë§Œì´ë©´ ë¬¸ì œ ì˜ì‹¬
        logger.warning(f"Low buffering: {percent}%")
```

---

## ê´€ë ¨ ì´ìŠˆ ë° ë¬¸ì„œ

- **ì´ìŠˆ**: ì¹´ë©”ë¼ ì—°ê²° ëŠê¹€ ì¡°ê¸° ê°ì§€ ìš”êµ¬ì‚¬í•­
- **ê´€ë ¨ ë¬¸ì„œ**:
  - `_doc/camera_disconnect_error_analysis.md`
  - `_doc/gstreamer_bus_message_patterns.md`
  - `_doc/usb_reconnection_permission_error_fix.md`

---

## ê²°ë¡ 

### ê°œì„  íš¨ê³¼

1. **ê°ì§€ ì‹œê°„ 83-90% ë‹¨ì¶•**: 30-60ì´ˆ â†’ 5-10ì´ˆ
2. **ì‚¬ìš©ì ê²½í—˜ ëŒ€í­ ê°œì„ **: ë¹ ë¥¸ ì¬ì—°ê²°ë¡œ ë…¹í™” ì†ì‹¤ ìµœì†Œí™”
3. **ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ ë¬´ì‹œ ê°€ëŠ¥**: í•˜ë£¨ 3.46MB
4. **ì„¤ì • ìœ ì—°ì„±**: `keepalive_timeout`ìœ¼ë¡œ ì¡°ì • ê°€ëŠ¥

### ê¶Œì¥ ì„¤ì •

```json
{
  "streaming": {
    "keepalive_timeout": 5,  // ê· í˜• ì¡íŒ ì„¤ì •
    "auto_reconnect": true,
    "max_reconnect_attempts": 5,
    "reconnect_delay_seconds": 5
  }
}
```

### ë‹¤ìŒ ë‹¨ê³„

Phase 2 (í”„ë ˆì„ ëª¨ë‹ˆí„°ë§) êµ¬í˜„ìœ¼ë¡œ ê°ì§€ ì‹œê°„ì„ 1-2ì´ˆê¹Œì§€ ë‹¨ì¶• ê°€ëŠ¥í•©ë‹ˆë‹¤.

---

**ì‘ì„±ì:** Claude Code
**Phase 1 êµ¬í˜„ ì™„ë£Œ:** 2025-11-10
